{% extends 'analysis/base.html' %}

{% block title %}D·ª± ƒêo√°n Doanh S·ªë - Perfume Sales Analytics{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0">üîÆ D·ª± ƒêo√°n Doanh S·ªë N∆∞·ªõc Hoa</h3>
                    <p class="mb-0 mt-2">Nh·∫≠p th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ d·ª± ƒëo√°n s·ªë l∆∞·ª£ng b√°n</p>
                </div>
                <div class="card-body p-4">
                    <form id="predictForm" method="post">
                        {% csrf_token %}

                        <!-- Product Info -->
                        <h5 class="mb-3">üì¶ Th√¥ng Tin S·∫£n Ph·∫©m</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="brand" class="form-label">Th∆∞∆°ng Hi·ªáu *</label>
                                <select class="form-select" id="brand" name="brand" required>
                                    <option value="">Ch·ªçn th∆∞∆°ng hi·ªáu...</option>
                                    {% for brand in brands %}
                                    <option value="{{ brand.name }}">{{ brand.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="title" class="form-label">T√™n S·∫£n Ph·∫©m *</label>
                                <input type="text" class="form-control" id="title" name="title" required
                                    placeholder="VD: Dior Sauvage EDT 100ml">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="type" class="form-label">Lo·∫°i/N·ªìng ƒê·ªô *</label>
                                <select class="form-select" id="type" name="type" required>
                                    <option value="EDT" selected>EDT (Eau de Toilette)</option>
                                    <option value="EDP">EDP (Eau de Parfum)</option>
                                    <option value="Parfum">Parfum</option>
                                    <option value="Cologne">Cologne</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="price" class="form-label">Gi√° (USD) *</label>
                                <input type="number" class="form-control" id="price" name="price" value="100" min="1"
                                    step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label for="available" class="form-label">S·ªë L∆∞·ª£ng C√≤n *</label>
                                <input type="number" class="form-control" id="available" name="available" value="50"
                                    min="0" required>
                            </div>
                        </div>

                        <!-- Location Info -->
                        <h5 class="mb-3">üåç Th√¥ng Tin ƒê·ªãa ƒêi·ªÉm</h5>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="country" class="form-label">Qu·ªëc Gia *</label>
                                <select class="form-select" id="country" name="country" required>
                                    {% for country in countries %}
                                    <option value="{{ country }}" {% if country == "US" %}selected{% endif %}>
                                        {{ country }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="state_city" class="form-label">Th√†nh Ph·ªë/Bang</label>
                                <input type="text" class="form-control" id="state_city" name="state_city"
                                    value="New York" placeholder="VD: New York, London, Paris">
                            </div>
                        </div>

                        <!-- Time Info -->
                        <h5 class="mb-3">‚è∞ Th√¥ng Tin Th·ªùi Gian</h5>
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="days_since_update" class="form-label">
                                    S·ªë Ng√†y K·ªÉ T·ª´ L·∫ßn C·∫≠p Nh·∫≠t Cu·ªëi
                                </label>
                                <input type="number" class="form-control" id="days_since_update"
                                    name="days_since_update" value="0" min="0" placeholder="0 = h√¥m nay">
                                <small class="text-muted">
                                    C√†ng m·ªõi c·∫≠p nh·∫≠t (s·ªë ng√†y th·∫•p) th√¨ kh·∫£ nƒÉng b√°n cao h∆°n
                                </small>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span id="submitText">üîÆ D·ª± ƒêo√°n Doanh S·ªë</span>
                                <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none"></span>
                            </button>
                        </div>
                    </form>

                    <!-- Result Section -->
                    <div id="resultSection" class="mt-4 d-none">
                        <div class="alert alert-success" role="alert">
                            <h5 class="alert-heading">üéâ K·∫øt Qu·∫£ D·ª± ƒêo√°n</h5>
                            <hr>
                            <div class="row">
                                <div class="col-md-8">
                                    <p class="mb-0">
                                        <strong id="perfumeName"></strong>
                                    </p>
                                    <small class="text-muted" id="perfumeDetails"></small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <p class="mb-0">D·ª± ƒëo√°n b√°n ƒë∆∞·ª£c:</p>
                                    <h2 class="text-primary mb-0">
                                        <span id="predictedSales"></span> üì¶
                                    </h2>
                                    <small class="text-muted">s·∫£n ph·∫©m</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Section -->
                    <div id="errorSection" class="mt-4 d-none">
                        <div class="alert alert-danger" role="alert">
                            <h5 class="alert-heading">‚ùå L·ªói</h5>
                            <hr>
                            <p class="mb-0" id="errorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Metrics -->
            <div id="modelMetrics" class="mt-4 d-none">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìä ƒê√°nh Gi√° ƒê·ªô Ch√≠nh X√°c M√¥ H√¨nh</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- MAPE -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">MAPE - Sai S·ªë Ph·∫ßn TrƒÉm Tuy·ªát ƒê·ªëi</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span id="mapeValue" class="h4 mb-0"></span>
                                            <span id="mapeBadge" class="badge"></span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i>
                                            <span id="mapeDescription"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- R¬≤ Score -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">R¬≤ Score - ƒê·ªô Ph√π H·ª£p M√¥ H√¨nh</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span id="r2Score" class="h4 mb-0"></span>
                                            <span id="r2Badge" class="badge"></span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i>
                                            <span id="r2Description"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- RMSE & MAE -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">RMSE - Sai S·ªë B√¨nh Ph∆∞∆°ng</h6>
                                        <div class="mb-3">
                                            <span id="rmseValue" class="h5"></span>
                                            <span class="text-muted">s·∫£n ph·∫©m</span>
                                            <div class="progress mt-2" style="height: 10px;">
                                                <div id="rmseBar" class="progress-bar" role="progressbar"></div>
                                            </div>
                                            <small class="text-muted">ƒê·ªô l·ªách so v·ªõi gi√° tr·ªã th·ª±c</small>
                                        </div>

                                        <h6 class="card-title mt-4">MAE - Sai S·ªë Tuy·ªát ƒê·ªëi</h6>
                                        <div>
                                            <span id="maeValue" class="h5"></span>
                                            <span class="text-muted">s·∫£n ph·∫©m</span>
                                            <div class="progress mt-2" style="height: 10px;">
                                                <div id="maeBar" class="progress-bar bg-success" role="progressbar"></div>
                                            </div>
                                            <small class="text-muted">Sai s·ªë trung b√¨nh</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cross Validation & Overfit -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">Cross Validation</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>ƒê·ªô ·ªïn ƒë·ªãnh:</span>
                                                <span id="cvMean" class="fw-bold"></span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>ƒê·ªô l·ªách chu·∫©n:</span>
                                                <span id="cvStd" class="fw-bold"></span>
                                            </div>
                                            <div class="mt-2" id="cvStability"></div>
                                        </div>

                                        <h6 class="card-title mt-4">Overfit Gap</h6>
                                        <div>
                                            <div class="d-flex justify-content-between">
                                                <span>Ch√™nh l·ªách:</span>
                                                <span id="overfitGap" class="fw-bold"></span>
                                            </div>
                                            <div class="progress mt-2" style="height: 10px;">
                                                <div id="overfitBar" class="progress-bar bg-warning" role="progressbar"></div>
                                            </div>
                                            <div id="overfitStatus" class="mt-1 small"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üí° G·ª£i √ù T·ªëi ∆Øu Doanh S·ªë</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Gi√° c·∫£:</strong> Gi√° h·ª£p l√Ω theo th·ªã tr∆∞·ªùng (50-200 USD)</li>
                        <li><strong>T·ªìn kho:</strong> C√≥ ƒë·ªß h√†ng trong kho (Available > 10)</li>
                        <li><strong>C·∫≠p nh·∫≠t:</strong> S·∫£n ph·∫©m m·ªõi c·∫≠p nh·∫≠t th∆∞·ªùng b√°n t·ªët h∆°n</li>
                        <li><strong>Th∆∞∆°ng hi·ªáu:</strong> Brands n·ªïi ti·∫øng c√≥ ∆∞u th·∫ø</li>
                        <li><strong>ƒê·ªãa ƒëi·ªÉm:</strong> Th·ªã tr∆∞·ªùng l·ªõn c√≥ doanh s·ªë cao h∆°n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('predictForm').addEventListener('submit', function (e) {
    e.preventDefault();

    // Show loading
    document.getElementById('submitText').classList.add('d-none');
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('resultSection').classList.add('d-none');
    document.getElementById('errorSection').classList.add('d-none');
    document.getElementById('modelMetrics').classList.add('d-none');

    const formData = new FormData(this);

    fetch(this.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading
        document.getElementById('submitText').classList.remove('d-none');
        document.getElementById('loadingSpinner').classList.add('d-none');

        if (data.success) {
            // Show result
            document.getElementById('perfumeName').textContent = formData.get('title');
            document.getElementById('perfumeDetails').textContent =
                `${formData.get('brand')} | ${formData.get('type')} | $${formData.get('price')} | ${formData.get('state_city')}, ${formData.get('country')}`;
            document.getElementById('predictedSales').textContent = data.predicted_sales;
            document.getElementById('resultSection').classList.remove('d-none');

            // ‚úÖ X·ª¨ L√ù METRICS (Ch·ªâ 1 l·∫ßn duy nh·∫•t)
            if (data.metrics) {
                const m = data.metrics;

                // MAPE
                const mape = m.mape;
                document.getElementById('mapeValue').textContent = `${mape.toFixed(2)}%`;
                const mapeBadge = document.getElementById('mapeBadge');
                let mapeDesc = '';

                if (mape <= 10) {
                    mapeBadge.className = 'badge bg-success';
                    mapeBadge.textContent = 'R·∫•t t·ªët';
                    mapeDesc = 'M√¥ h√¨nh d·ª± ƒëo√°n r·∫•t ch√≠nh x√°c';
                } else if (mape <= 20) {
                    mapeBadge.className = 'badge bg-primary';
                    mapeBadge.textContent = 'T·ªët';
                    mapeDesc = 'M√¥ h√¨nh d·ª± ƒëo√°n ch·∫•p nh·∫≠n ƒë∆∞·ª£c';
                } else if (mape <= 30) {
                    mapeBadge.className = 'badge bg-warning';
                    mapeBadge.textContent = 'Trung b√¨nh';
                    mapeDesc = 'M√¥ h√¨nh c√≥ th·ªÉ c·∫ßn c·∫£i thi·ªán';
                } else {
                    mapeBadge.className = 'badge bg-danger';
                    mapeBadge.textContent = 'K√©m';
                    mapeDesc = 'M√¥ h√¨nh d·ª± ƒëo√°n kh√¥ng ·ªïn ƒë·ªãnh';
                }
                document.getElementById('mapeDescription').textContent = mapeDesc;

                // R¬≤ Score
                const r2 = m.r2;
                document.getElementById('r2Score').textContent = r2.toFixed(3);
                const r2Badge = document.getElementById('r2Badge');
                let r2Desc = '';

                if (r2 >= 0.7) {
                    r2Badge.className = 'badge bg-success';
                    r2Badge.textContent = 'T·ªët';
                    r2Desc = 'M√¥ h√¨nh gi·∫£i th√≠ch t·ªët d·ªØ li·ªáu';
                } else if (r2 >= 0.5) {
                    r2Badge.className = 'badge bg-primary';
                    r2Badge.textContent = 'Kh√°';
                    r2Desc = 'M√¥ h√¨nh gi·∫£i th√≠ch t∆∞∆°ng ƒë·ªëi';
                } else {
                    r2Badge.className = 'badge bg-warning';
                    r2Badge.textContent = 'Y·∫øu';
                    r2Desc = 'M√¥ h√¨nh c·∫ßn c·∫£i thi·ªán';
                }
                document.getElementById('r2Description').textContent = r2Desc;

                // RMSE
                const rmse = m.rmse;
                document.getElementById('rmseValue').textContent = rmse.toFixed(0);
                const rmseBar = document.getElementById('rmseBar');
                const rmsePercent = Math.min(100, (rmse / 200) * 100);
                rmseBar.style.width = `${rmsePercent}%`;
                rmseBar.className = `progress-bar ${rmse > 100 ? 'bg-danger' : rmse > 50 ? 'bg-warning' : 'bg-success'}`;

                // MAE
                const mae = m.mae;
                document.getElementById('maeValue').textContent = mae.toFixed(0);
                const maeBar = document.getElementById('maeBar');
                const maePercent = Math.min(100, (mae / 200) * 100);
                maeBar.style.width = `${maePercent}%`;
                maeBar.className = `progress-bar ${mae > 100 ? 'bg-danger' : mae > 50 ? 'bg-warning' : 'bg-success'}`;

                // Cross Validation
                document.getElementById('cvMean').textContent = m.cv_mean.toFixed(3);
                document.getElementById('cvStd').textContent = m.cv_std.toFixed(3);

                const cvStability = document.getElementById('cvStability');
                if (m.cv_std < 0.1) {
                    cvStability.innerHTML = '<span class="badge bg-success">·ªîn ƒë·ªãnh cao</span> M√¥ h√¨nh ·ªïn ƒë·ªãnh';
                } else if (m.cv_std < 0.2) {
                    cvStability.innerHTML = '<span class="badge bg-primary">Kh√° ·ªïn ƒë·ªãnh</span> T∆∞∆°ng ƒë·ªëi ·ªïn ƒë·ªãnh';
                } else {
                    cvStability.innerHTML = '<span class="badge bg-warning">Kh√¥ng ·ªïn ƒë·ªãnh</span> C·∫ßn c·∫£i thi·ªán';
                }

                // Overfit Gap
                const overfitGap = m.overfit_gap;
                document.getElementById('overfitGap').textContent = overfitGap.toFixed(3);
                const overfitBar = document.getElementById('overfitBar');
                const overfitStatus = document.getElementById('overfitStatus');
                const overfitPercent = Math.min(100, (overfitGap / 0.3) * 100);
                overfitBar.style.width = `${overfitPercent}%`;

                if (overfitGap > 0.15) {
                    overfitBar.className = 'progress-bar bg-danger';
                    overfitStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i> M√¥ h√¨nh c√≥ th·ªÉ overfit';
                } else if (overfitGap > 0.1) {
                    overfitBar.className = 'progress-bar bg-warning';
                    overfitStatus.innerHTML = '<i class="bi bi-info-circle-fill text-warning"></i> H∆°i overfit';
                } else {
                    overfitBar.className = 'progress-bar bg-success';
                    overfitStatus.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> C√¢n b·∫±ng t·ªët';
                }

                // Show metrics section
                document.getElementById('modelMetrics').classList.remove('d-none');
            }

            // Scroll to result
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        } else {
            // Show error
            document.getElementById('errorMessage').textContent = data.error || 'C√≥ l·ªói x·∫£y ra';
            document.getElementById('errorSection').classList.remove('d-none');
        }
    })
    .catch(error => {
        document.getElementById('submitText').classList.remove('d-none');
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('errorMessage').textContent = 'L·ªói: ' + error.message;
        document.getElementById('errorSection').classList.remove('d-none');
    });
});
</script>
{% endblock %}